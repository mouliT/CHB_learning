# Vasishta CHB Tutorial — Project Instructions

## Project Identity
- **Student:** Vasishta
- **Paper:** "DC-Link Voltage Balancing Modulation for Cascaded H-Bridge Converters" — Ko, Tcai, Liserre, IEEE Access 2021
- **Document:** `CHB_DC_Link_Voltage_Balancing.tex`
- **Repo:** https://github.com/mouliT/CHB_learning (Overleaf pulls from GitHub for compilation)
- **Workflow:** edit locally → git commit/push → Overleaf pull → compile → student reads → green signal → next section

## Hard Rules
1. **One section at a time.** Write one section, stop, wait for the user's explicit green signal before writing the next. Never pre-populate multiple sections.
2. **Commit and push automatically** after every correction or new section. Do NOT ask for push permission — it is pre-approved for this project.
3. **Pull before editing** if the user says they pushed from Overleaf (`git pull` first).
4. **Read the paper figure before describing it.** Do NOT describe control loops, signals, or block-diagram topology from prior knowledge alone — look at the actual figure image. Classic mistake: assuming "outer = current, inner = voltage" when this paper's Fig. 2 has outer = DC voltage control, inner = current control.
5. **Never use `\ref` to a label that does not yet exist.** Forward references to unwritten sections or undefined figures compile as `??`. Rule: if the target section/figure is not yet in the document, use plain text (e.g. "the next section" or "paper Fig. 9") instead of a `\ref`.
6. **Every paper figure must be explained in full in its assigned section.** Do not silently skip any figure — even if a figure is deferred to a later section, it must receive a complete explanation (caption + prose + box) when that section is written. Splitting concepts across sections is fine; omitting a figure's explanation entirely is not.

## Document Structure
- Uses `\setcounter{section}{-1}` so Section 0 exists before Section 1.
- LaTeX macros defined in preamble: `\vg`, `\ig`, `\Vdc`, `\Vdci{i}`, `\Mi`, `\phic`, `\PH`, `\PHi{i}`, `\PHnc`, `\PHcl`, `\Vtot`, `\figref`, `\omg`, `\phig`, `\Ig`
- Figure macro: `\figentry{label}{filename-no-ext}{caption}{width}` (4 args, no .png extension)
- `\graphicspath{{figures/}}` — all PNGs live in `figures/`
- tcolorbox environments: `circuitbox` (blue), `statebox` (orange), `eqnbox` (green), `physbox` (gray), `warningbox` (red)

## Figures
- **Paper figures:** `figures/DLVBMCHBC_Fig[N]_page[XX].png` (N = 1..14)
- **Custom figures:** generated by Python scripts in the project root
  - `gen_staircase_buildup.py` → `CHB_staircase_buildup.png` (fc = 12f, n=3 cell breakdown) — **in document**
  - `gen_staircase.py` → `CHB_staircase_summation.png` (fc = 6f, n=1..4 comparison) — **NOT in document** (TODO comment marks the spot)

## Known Bugs — Do NOT Re-introduce
1. **Unipolar PWM comparator:** must use `np.abs(carrier)`, NOT `carrier`. The old formula `ref > carrier` fired when carrier was negative, causing DC offset and wrong null states.
2. **Figure filenames:** `DLVBMCHBC_Fig*` (NOT `P3_Fig*` — that was a previous naming convention).
3. **Grid voltage equation:** `v_g = v_1 + v_2 + ... + v_n` (NOT `i_g × sum(...)` — that is dimensionally wrong).
4. **Torch battery analogy:** removed by user — do not re-introduce it.
5. **Control loop hierarchy (§2.2, paper Fig. 2):** outer loop = DC-link voltage control (slow, produces I_g*); inner loop = grid current control (fast, produces v_ref); balancing algorithm is a third separate layer adjusting individual Mi. Do NOT swap inner and outer — this was written incorrectly and corrected.

## Document Progress
| Section | Status | Notes |
|---|---|---|
| §0 Before You Begin | ✅ Complete | All 6 subsections, buildup figure embedded |
| §1 The Circuit | ✅ Complete | Paper Fig.1, component walk-through, loading power with governing equations |
| §2 From Loading Power to Control | ✅ Complete | P_H,i derivation (product-to-sum), Mi* formula, Fig.2 control scheme (outer=voltage, inner=current, balancing=3rd layer) |
| §3+ | ⏳ Awaiting green signal on §2 | |

## Key Equations (for continuity across sections)
- Capacitor energy balance: `C·Vdc,i·dVdc,i/dt = P_i,src - P_H,i`
- Steady-state condition per cycle k: `P_H,i(k) = P_i,src(k)`
- Non-clamped loading power: `P_H,i = ½·Vdc,i·Mi·Ig·cos(φ_g)`
- Modulation index target: `Mi* = 2·P_i,src / (Vdc,i·Ig·cos(φ_g))`
- Coupling constraint: `Σ Vdc,i·Mi = Vref`
- Control loop order (paper Fig. 2): outer = DC voltage → produces Ig*; inner = current control → produces Vref; balancing = per-cell Mi adjustment
